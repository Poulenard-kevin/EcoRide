{# templates/review/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Gestion des avis{% endblock %}

{% block body %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex align-items-center justify-content-between bg-primary text-white">
      <h3 class="h5 mb-0">Gestion des avis</h3>

      <div class="btn-group btn-group-sm" role="group" aria-label="Filtre avis">
        <a href="{{ path('review_index', {pending: 1}) }}"
           class="btn btn-light {% if onlyNotValidated %}active{% endif %}">
          En attente
        </a>
        <a href="{{ path('review_index', {pending: 0}) }}"
           class="btn btn-light {% if not onlyNotValidated %}active{% endif %}">
          Tous
        </a>
      </div>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:60px">#</th>
              <th style="width:90px">Note</th>
              <th>Auteur</th>
              <th>Cible</th>
              <th style="width:110px">Covoiturage</th>
              <th>Commentaire</th>
              <th style="width:140px">Date</th>
              <th style="width:110px">Statut</th>
              <th class="text-end" style="width:220px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reviews %}
              <tr>
                <td class="fw-semibold">{{ r.id }}</td>

                <td>
                  <span class="text-warning" title="{{ r.rating }} / 5">
                    {% for i in 1..5 %}
                      <i class="bi {% if i <= r.rating %}bi-star-fill{% else %}bi-star{% endif %}"></i>
                    {% endfor %}
                  </span>
                  <div class="small text-muted">{{ r.rating }}/5</div>
                </td>

                <td>
                  {% if r.author %}
                    <a href="{{ path('app_user_show', {id: r.author.id}) }}">
                      {{ (r.author.firstName ~ ' ' ~ r.author.lastName)|trim }}
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td>
                  {% if r.target %}
                    <a href="{{ path('app_user_show', {id: r.target.id}) }}">
                      {{ (r.target.firstName ~ ' ' ~ r.target.lastName)|trim }}
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td>
                  {% if r.carpool %}
                    <a href="{{ path('app_carpool_show', {id: r.carpool.id}) }}">#{{ r.carpool.id }}</a>
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td>
                  {% if r.comment %}
                    <span
                      {% if r.comment|length > 80 %}data-bs-toggle="tooltip" title="{{ r.comment|e }}" {% endif %}>
                      {{ r.comment|striptags|length > 80 ? (r.comment|striptags|slice(0, 80) ~ '…') : r.comment|striptags }}
                    </span>
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td class="text-muted">{{ r.date ? r.date|date('d/m/Y H:i') : '' }}</td>

                <td>
                  {% if r.validated %}
                    <span class="badge bg-success">Validé</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">En attente</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  <div class="d-inline-flex align-items-center">
                    {% if not r.validated %}
                      {# Valider #}
                      <form method="post" action="{{ path('review_approve', {id: r.id}) }}" class="me-1">
                        <input type="hidden" name="_token" value="{{ csrf_token('approve' ~ r.id) }}">
                        <button class="btn btn-sm btn-success" title="Valider">
                          <i class="bi bi-check2"></i>
                        </button>
                      </form>

                      {# Rejeter / supprimer #}
                      <form method="post" action="{{ path('review_reject', {id: r.id}) }}" class="me-1"
                            onsubmit="return confirm('Rejeter et supprimer cet avis ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('reject' ~ r.id) }}">
                        <button class="btn btn-sm btn-danger" title="Rejeter">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    {% else %}
                      {# Supprimer même si validé #}
                      <form method="post" action="{{ path('review_delete_front', {id: r.id}) }}" class="me-1"
                            onsubmit="return confirm('Supprimer cet avis ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ r.id) }}">
                        <button class="btn btn-sm btn-outline-danger" title="Supprimer">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    {% endif %}

                    {# Lien voir / éditer #}
                    <a href="{{ path('review_edit', {id: r.id}) }}" class="btn btn-sm btn-outline-secondary" title="Éditer">
                      <i class="bi bi-pencil"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">Aucun avis.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}